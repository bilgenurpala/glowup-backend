<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äî GlowUp</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: var(--black);
      border-right: var(--border-thick);
      display: flex;
      flex-direction: column;
      padding: 28px 20px;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 50;
    }

    .sidebar-logo {
      font-size: 24px;
      font-weight: 800;
      color: var(--yellow);
      letter-spacing: -0.5px;
      padding: 0 8px;
      margin-bottom: 36px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 14px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      color: #aaa;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.08);
      color: var(--white);
    }

    .nav-item.active {
      background: var(--yellow);
      border-color: var(--yellow);
      color: var(--black);
      box-shadow: 3px 3px 0px rgba(255,255,255,0.2);
    }

    .nav-item svg { flex-shrink: 0; }

    .sidebar-user {
      border-top: 2px solid rgba(255,255,255,0.15);
      padding-top: 20px;
      margin-top: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--teal);
      border: 2px solid var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 800;
      color: var(--black);
      flex-shrink: 0;
    }

    .user-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-email {
      font-size: 11px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .logout-btn {
      width: 100%;
      justify-content: flex-start;
      gap: 10px;
      padding: 10px 14px;
      font-size: 13px;
      background: rgba(255,255,255,0.08);
      color: #aaa;
      border-color: rgba(255,255,255,0.15);
      box-shadow: none;
    }

    .logout-btn:hover {
      background: var(--coral);
      color: var(--white);
      border-color: var(--coral);
      box-shadow: 3px 3px 0px rgba(0,0,0,0.3);
    }

    .main {
      margin-left: 260px;
      flex: 1;
      padding: 48px 48px 60px;
      min-height: 100vh;
    }

    .page { display: none; }
    .page.active { display: block; }

    .page-header {
      margin-bottom: 36px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 4px;
    }

    .page-subtitle {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 36px;
    }

    .stat-card {
      padding: 28px 24px;
    }

    .stat-card-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #888;
      margin-bottom: 12px;
    }

    .stat-card-value {
      font-size: 42px;
      font-weight: 800;
      letter-spacing: -2px;
      line-height: 1;
    }

    .stat-card-icon {
      font-size: 28px;
      margin-bottom: 12px;
    }

    .stat-card:nth-child(1) { background: var(--yellow); }
    .stat-card:nth-child(2) { background: var(--teal); }
    .stat-card:nth-child(3) { background: var(--mint); }

    .overview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 36px;
    }

    .info-card { padding: 28px; }

    .info-card-title {
      font-size: 15px;
      font-weight: 800;
      letter-spacing: -0.3px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-card-title-icon {
      width: 28px;
      height: 28px;
      border: var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: var(--shadow-sm);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 11px 0;
      border-bottom: 2px solid #eee;
      font-size: 13px;
    }

    .info-row:last-child { border-bottom: none; }

    .info-key {
      font-weight: 700;
      color: #666;
    }

    .info-val {
      font-weight: 600;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: #f0f0e0;
      border: 1px solid #ddd;
      padding: 3px 10px;
      border-radius: 4px;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .table-wrap {
      padding: 0;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      padding: 14px 20px;
      text-align: left;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #888;
      background: #f5f5e8;
      border-bottom: var(--border-thick);
    }

    tbody td {
      padding: 16px 20px;
      font-size: 14px;
      border-bottom: 2px solid #f0f0e0;
      font-weight: 500;
    }

    tbody tr:last-child td { border-bottom: none; }

    tbody tr:hover td { background: #fafaee; }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-cell-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--purple);
      border: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 800;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }

    .user-cell-name { font-weight: 700; font-size: 14px; }
    .user-cell-email { font-size: 12px; color: #888; font-weight: 500; }

    .actions-cell { display: flex; gap: 8px; }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-top: var(--border-thick);
      background: #f5f5e8;
    }

    .pagination-info {
      font-size: 13px;
      font-weight: 700;
      color: #666;
    }

    .pagination-btns { display: flex; gap: 8px; }

    .empty-state {
      text-align: center;
      padding: 72px 24px;
    }

    .empty-state-icon { font-size: 48px; margin-bottom: 20px; }

    .empty-state-text {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .empty-state-sub { font-size: 13px; color: #777; font-weight: 500; }

    .loading-state {
      text-align: center;
      padding: 72px;
    }

    .api-tester { display: flex; flex-direction: column; gap: 20px; }

    .request-builder { padding: 28px; }

    .section-label-sm {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #888;
      margin-bottom: 10px;
    }

    .endpoint-shortcuts {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .shortcut-btn {
      padding: 7px 14px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      border: var(--border);
      background: var(--white);
      color: var(--black);
      font-family: 'Space Grotesk', sans-serif;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }

    .shortcut-btn:hover {
      background: var(--yellow);
      transform: translate(-2px, -2px);
      box-shadow: var(--shadow);
    }

    .method-url-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .method-select {
      padding: 13px 16px;
      background: var(--white);
      border: var(--border);
      border-radius: var(--radius-sm);
      color: var(--black);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 800;
      outline: none;
      cursor: pointer;
      min-width: 120px;
      box-shadow: var(--shadow-sm);
    }

    .url-input { flex: 1; }

    .body-area {
      width: 100%;
      min-height: 140px;
      padding: 14px 16px;
      background: var(--white);
      border: var(--border);
      border-radius: var(--radius-sm);
      color: var(--black);
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.7;
      resize: vertical;
      outline: none;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }

    .body-area:focus {
      box-shadow: var(--shadow);
      transform: translate(-1px, -1px);
    }

    .response-panel { padding: 28px; }

    .response-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .response-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 14px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 700;
      border: var(--border);
      box-shadow: var(--shadow-sm);
    }

    .status-2xx { background: var(--mint); color: var(--black); }
    .status-4xx, .status-5xx { background: var(--coral); color: var(--white); }

    .response-pre {
      background: var(--black);
      border: var(--border-thick);
      border-radius: var(--radius-sm);
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.7;
      color: #A8E6CF;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
      min-height: 80px;
      box-shadow: var(--shadow);
    }

    .send-row {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .auth-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: #666;
      cursor: pointer;
    }

    @media (max-width: 960px) {
      .sidebar { display: none; }
      .main { margin-left: 0; padding: 24px; }
      .stats-row { grid-template-columns: 1fr; }
      .overview-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-logo">‚ú¶ GlowUp</div>

      <nav class="sidebar-nav">
        <div class="nav-item active" data-page="overview" onclick="showPage('overview')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Overview
        </div>
        <div class="nav-item" data-page="users" onclick="showPage('users')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Users
        </div>
        <div class="nav-item" data-page="tester" onclick="showPage('tester')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          API Tester
        </div>
        <a href="/api-docs" target="_blank" class="nav-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          API Docs ‚Üó
        </a>
      </nav>

      <div class="sidebar-user">
        <div class="user-info">
          <div class="user-avatar" id="sidebarAvatar">?</div>
          <div>
            <div class="user-name" id="sidebarName">Loading...</div>
            <div class="user-email" id="sidebarEmail"></div>
          </div>
        </div>
        <button class="btn logout-btn" onclick="handleLogout()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Sign Out
        </button>
      </div>
    </aside>

    <main class="main">

      <div class="page active" id="page-overview">
        <div class="page-header">
          <div>
            <h1 class="page-title">Overview üëã</h1>
            <p class="page-subtitle">Welcome back, <strong id="welcomeName">‚Äî</strong></p>
          </div>
        </div>

        <div class="stats-row">
          <div class="card stat-card">
            <div class="stat-card-icon">üë•</div>
            <div class="stat-card-label">Total Users</div>
            <div class="stat-card-value" id="totalUsers">‚Äî</div>
          </div>
          <div class="card stat-card">
            <div class="stat-card-icon">üîê</div>
            <div class="stat-card-label">Auth Status</div>
            <div class="stat-card-value" style="font-size: 20px; padding-top: 4px;">
              <span class="badge badge-teal">Active ‚úì</span>
            </div>
          </div>
          <div class="card stat-card">
            <div class="stat-card-icon">‚ö°</div>
            <div class="stat-card-label">API Status</div>
            <div class="stat-card-value" id="apiStatus" style="font-size: 20px; padding-top: 4px;">‚Äî</div>
          </div>
        </div>

        <div class="overview-grid">
          <div class="card info-card">
            <div class="info-card-title">
              <span class="info-card-title-icon" style="background:var(--yellow);">üë§</span>
              Your Profile
            </div>
            <div class="info-row">
              <span class="info-key">Name</span>
              <span class="info-val" id="profileName">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="info-key">Email</span>
              <span class="info-val" id="profileEmail">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="info-key">User ID</span>
              <span class="info-val" id="profileId">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="info-key">Joined</span>
              <span class="info-val" id="profileJoined">‚Äî</span>
            </div>
          </div>

          <div class="card info-card">
            <div class="info-card-title">
              <span class="info-card-title-icon" style="background:var(--purple);">üîë</span>
              Access Token
            </div>
            <div class="info-row">
              <span class="info-key">Token</span>
              <span class="info-val" id="tokenPreview">‚Äî</span>
            </div>
            <div class="info-row">
              <span class="info-key">Type</span>
              <span class="info-val">Bearer JWT</span>
            </div>
            <div class="info-row">
              <span class="info-key">Expires</span>
              <span class="info-val">15 minutes</span>
            </div>
          </div>
        </div>
      </div>

      <div class="page" id="page-users">
        <div class="page-header">
          <div>
            <h1 class="page-title">Users üë•</h1>
            <p class="page-subtitle">Manage all registered users</p>
          </div>
          <button class="btn btn-primary" onclick="openAddModal()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add User
          </button>
        </div>

        <div class="card table-wrap">
          <div id="usersTableContent">
            <div class="loading-state">
              <div class="spinner" style="margin: 0 auto;"></div>
            </div>
          </div>
          <div class="pagination" id="paginationBar" style="display: none;">
            <span class="pagination-info" id="paginationInfo"></span>
            <div class="pagination-btns">
              <button class="btn btn-ghost btn-sm" id="prevBtn" onclick="changePage(-1)">‚Üê Prev</button>
              <button class="btn btn-ghost btn-sm" id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <div class="page" id="page-tester">
        <div class="page-header">
          <div>
            <h1 class="page-title">API Tester ‚ö°</h1>
            <p class="page-subtitle">Test your endpoints directly from the dashboard</p>
          </div>
        </div>

        <div class="api-tester">
          <div class="card request-builder">
            <div class="section-label-sm">Quick Endpoints</div>
            <div class="endpoint-shortcuts">
              <button class="shortcut-btn" onclick="loadShortcut('GET', '/health')">GET /health</button>
              <button class="shortcut-btn" onclick="loadShortcut('GET', '/users')">GET /users</button>
              <button class="shortcut-btn" onclick="loadShortcut('GET', '/auth/me')">GET /auth/me</button>
              <button class="shortcut-btn" onclick="loadShortcut('POST', '/auth/login')">POST /auth/login</button>
              <button class="shortcut-btn" onclick="loadShortcut('POST', '/users')">POST /users</button>
            </div>

            <div class="section-label-sm">Request</div>
            <div class="method-url-row">
              <select class="method-select" id="reqMethod">
                <option>GET</option>
                <option>POST</option>
                <option>PUT</option>
                <option>DELETE</option>
              </select>
              <input type="text" class="input-field url-input" id="reqUrl" placeholder="/users" value="/users" />
            </div>

            <div class="section-label-sm" style="margin-top: 4px;">Body (JSON)</div>
            <textarea class="body-area" id="reqBody" placeholder='{ "name": "John Doe" }'></textarea>

            <div class="send-row">
              <button class="btn btn-primary" onclick="sendRequest()" id="sendBtn">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                Send Request
              </button>
              <label class="auth-checkbox-label">
                <input type="checkbox" id="useAuth" checked />
                Include Auth Token
              </label>
            </div>
          </div>

          <div class="card response-panel">
            <div class="response-panel-header">
              <span style="font-size: 15px; font-weight: 800;">Response</span>
              <span id="responseStatus"></span>
            </div>
            <pre class="response-pre" id="responseOutput">Send a request to see the response here...</pre>
          </div>
        </div>
      </div>

    </main>
  </div>

  <div class="modal-overlay" id="userModal">
    <div class="modal">
      <h3 style="font-size: 20px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 28px;" id="modalTitle">Add User</h3>
      <div class="input-group" style="margin-bottom: 28px;">
        <label for="modalName">Name</label>
        <input type="text" id="modalName" class="input-field" placeholder="John Doe" />
      </div>
      <input type="hidden" id="modalUserId" />
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="modalSaveBtn" onclick="saveUser()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width: 400px;">
      <div style="font-size: 40px; margin-bottom: 16px;">üóëÔ∏è</div>
      <h3 style="font-size: 20px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 10px;">Delete user?</h3>
      <p style="font-size: 14px; color: #666; font-weight: 500; margin-bottom: 28px;">This action cannot be undone.</p>
      <input type="hidden" id="deleteUserId" />
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-coral" id="confirmDeleteBtn" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    requireAuth();

    let currentPage = 1;
    const limit = 10;

    const user = JSON.parse(localStorage.getItem('user') || '{}');

    const initUser = () => {
      const name = user.name || 'User';
      const email = user.email || '';
      const initial = name.charAt(0).toUpperCase();

      document.getElementById('sidebarAvatar').textContent = initial;
      document.getElementById('sidebarName').textContent = name;
      document.getElementById('sidebarEmail').textContent = email;
      document.getElementById('welcomeName').textContent = name;
      document.getElementById('profileName').textContent = name;
      document.getElementById('profileEmail').textContent = email;
      document.getElementById('profileId').textContent = user.id || '‚Äî';
      document.getElementById('profileJoined').textContent = user.created_at
        ? new Date(user.created_at).toLocaleDateString()
        : '‚Äî';

      const token = getToken();
      document.getElementById('tokenPreview').textContent = token
        ? token.substring(0, 20) + '...'
        : '‚Äî';
    };

    const checkApiStatus = async () => {
      try {
        const res = await fetch('/health');
        const data = await res.json();
        document.getElementById('apiStatus').innerHTML = data.success
          ? '<span class="badge badge-mint">Online ‚úì</span>'
          : '<span class="badge badge-coral">Offline</span>';
      } catch {
        document.getElementById('apiStatus').innerHTML = '<span class="badge badge-coral">Offline</span>';
      }
    };

    const showPage = (page) => {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');
      document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
      if (page === 'users') loadUsers();
    };

    const loadUsers = async () => {
      document.getElementById('usersTableContent').innerHTML = `
        <div class="loading-state"><div class="spinner" style="margin: 0 auto;"></div></div>
      `;
      document.getElementById('paginationBar').style.display = 'none';

      try {
        const res = await api.getUsers(currentPage, limit);
        const users = res.data.users;

        document.getElementById('totalUsers').textContent = users.length;

        if (users.length === 0) {
          document.getElementById('usersTableContent').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üë•</div>
              <div class="empty-state-text">No users yet</div>
              <div class="empty-state-sub">Add your first user to get started</div>
            </div>
          `;
          return;
        }

        const avatarColors = ['var(--yellow)', 'var(--teal)', 'var(--coral)', 'var(--purple)', 'var(--mint)', 'var(--orange)'];

        const rows = users.map((u, i) => `
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-cell-avatar" style="background:${avatarColors[i % avatarColors.length]}">
                  ${u.name.charAt(0).toUpperCase()}
                </div>
                <div>
                  <div class="user-cell-name">${escapeHtml(u.name)}</div>
                  ${u.email ? `<div class="user-cell-email">${escapeHtml(u.email)}</div>` : ''}
                </div>
              </div>
            </td>
            <td style="color:#999;font-family:monospace;font-size:13px;">#${u.id}</td>
            <td style="color:#888;font-size:13px;font-weight:500;">${new Date(u.created_at).toLocaleDateString()}</td>
            <td>
              <div class="actions-cell">
                <button class="btn btn-ghost btn-sm" onclick="openEditModal(${u.id}, '${escapeHtml(u.name)}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');

        document.getElementById('usersTableContent').innerHTML = `
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>ID</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;

        document.getElementById('paginationBar').style.display = 'flex';
        document.getElementById('paginationInfo').textContent = `Page ${currentPage}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = users.length < limit;

      } catch (err) {
        document.getElementById('usersTableContent').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <div class="empty-state-text">Failed to load users</div>
            <div class="empty-state-sub">${err.message}</div>
          </div>
        `;
      }
    };

    const changePage = (dir) => {
      currentPage = Math.max(1, currentPage + dir);
      loadUsers();
    };

    const escapeHtml = (str) =>
      String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    const openAddModal = () => {
      document.getElementById('modalTitle').textContent = 'Add User';
      document.getElementById('modalName').value = '';
      document.getElementById('modalUserId').value = '';
      document.getElementById('modalSaveBtn').textContent = 'Add User';
      document.getElementById('userModal').classList.add('active');
      setTimeout(() => document.getElementById('modalName').focus(), 100);
    };

    const openEditModal = (id, name) => {
      document.getElementById('modalTitle').textContent = 'Edit User';
      document.getElementById('modalName').value = name;
      document.getElementById('modalUserId').value = id;
      document.getElementById('modalSaveBtn').textContent = 'Save Changes';
      document.getElementById('userModal').classList.add('active');
      setTimeout(() => document.getElementById('modalName').focus(), 100);
    };

    const closeModal = () => {
      document.getElementById('userModal').classList.remove('active');
    };

    const saveUser = async () => {
      const name = document.getElementById('modalName').value.trim();
      const id = document.getElementById('modalUserId').value;
      const btn = document.getElementById('modalSaveBtn');

      if (!name) { showToast('Name is required', 'error'); return; }

      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';

      try {
        if (id) {
          await api.updateUser(id, name);
          showToast('User updated');
        } else {
          await api.createUser(name);
          showToast('User created');
        }
        closeModal();
        loadUsers();
      } catch (err) {
        showToast(err.message, 'error');
        btn.disabled = false;
        btn.textContent = id ? 'Save Changes' : 'Add User';
      }
    };

    const deleteUser = (id) => {
      document.getElementById('deleteUserId').value = id;
      document.getElementById('deleteModal').classList.add('active');
    };

    const closeDeleteModal = () => {
      document.getElementById('deleteModal').classList.remove('active');
    };

    const confirmDelete = async () => {
      const id = document.getElementById('deleteUserId').value;
      const btn = document.getElementById('confirmDeleteBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';
      try {
        await api.deleteUser(id);
        closeDeleteModal();
        showToast('User deleted');
        loadUsers();
      } catch (err) {
        showToast(err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Delete';
      }
    };

    const handleLogout = async () => {
      try { await api.logout(); } catch {}
      clearTokens();
      window.location.href = '/login.html';
    };

    const loadShortcut = (method, url) => {
      document.getElementById('reqMethod').value = method;
      document.getElementById('reqUrl').value = url;

      const bodies = {
        'POST /auth/login': '{\n  "email": "you@example.com",\n  "password": "Password1"\n}',
        'POST /users': '{\n  "name": "John Doe"\n}',
      };
      document.getElementById('reqBody').value = bodies[`${method} ${url}`] || '';
    };

    const sendRequest = async () => {
      const method = document.getElementById('reqMethod').value;
      const url = document.getElementById('reqUrl').value.trim();
      const bodyText = document.getElementById('reqBody').value.trim();
      const useAuth = document.getElementById('useAuth').checked;
      const btn = document.getElementById('sendBtn');
      const output = document.getElementById('responseOutput');
      const statusEl = document.getElementById('responseStatus');

      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Sending...';
      output.textContent = 'Loading...';
      statusEl.innerHTML = '';

      const headers = { 'Content-Type': 'application/json' };
      if (useAuth && getToken()) headers['Authorization'] = `Bearer ${getToken()}`;

      const options = { method, headers };
      if (['POST', 'PUT', 'PATCH'].includes(method) && bodyText) {
        options.body = bodyText;
      }

      try {
        const start = Date.now();
        const res = await fetch(url, options);
        const ms = Date.now() - start;
        const data = await res.json();

        const statusClass = res.status < 300 ? 'status-2xx' : res.status < 500 ? 'status-4xx' : 'status-5xx';
        statusEl.innerHTML = `
          <span class="response-status-badge ${statusClass}">${res.status} ${res.statusText}</span>
          <span style="font-size:12px;color:#999;margin-left:8px;font-weight:600;">${ms}ms</span>
        `;
        output.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        statusEl.innerHTML = `<span class="response-status-badge status-5xx">Error</span>`;
        output.textContent = err.message;
      }

      btn.disabled = false;
      btn.innerHTML = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Send Request';
    };

    document.getElementById('userModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    document.getElementById('deleteModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeDeleteModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeModal(); closeDeleteModal(); }
    });

    initUser();
    checkApiStatus();
    loadUsers();
  </script>
</body>
</html>
